<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Multi-Step Puzzle Helper</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: #f4f4f4;
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            font-size: 16px;
        }

        #app-container {
            width: 100%;
            max-width: 600px; /* Max width for larger screens, but primarily mobile */
            margin: 0 auto;
            background-color: #fff;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        #app-header {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        #app-header button {
            background-color: #0056b3;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            white-space: nowrap; /* Added to prevent text wrapping */
        }
        #app-header button:disabled {
            background-color: #aaa;
            cursor: not-allowed;
        }

        #step-title {
            font-size: 1.1em;
            margin: 0;
            text-align: center;
            flex-grow: 1;
            padding: 0 10px;
        }

        #step-content {
            padding: 20px;
            flex-grow: 1;
            overflow-y: auto;
        }

        #step-content h3 {
            margin-top: 0;
            color: #007bff;
        }

        #app-footer {
            padding: 15px;
            text-align: center;
            border-top: 1px solid #eee;
        }

        #restart-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
        }
        #restart-btn:hover {
            background-color: #c82333;
        }
        
        .action-button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            width: 100%;
            margin-top: 20px;
            display: block;
        }
        .action-button:hover {
            background-color: #218838;
        }

        /* Picture selection styling */
        .picture-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            gap: 10px;
            justify-items: center;
        }
        .picture-item {
            cursor: pointer;
            text-align: center;
            padding: 5px;
            border: 2px solid transparent;
            border-radius: 4px;
            transition: border-color 0.3s;
        }
        .picture-item img {
            width: 110px;
            height: 110px;
            object-fit: cover;
            border-radius: 4px;
            display: block;
            margin-bottom: 5px;
        }
        .picture-item.selected {
            border-color: #007bff;
            background-color: #e7f3ff;
        }
        .picture-item span {
            font-size: 0.9em;
        }

        /* Roman numeral step styling */
        .roman-numeral-item {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .roman-numeral-images {
            display: flex;
            gap: 10px;
            margin-bottom: 8px;
            align-items: center;
        }
        .roman-numeral-images img {
            width: 80px; /* Slightly smaller to fit */
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        .roman-numeral-images .painting-image-preview {
            cursor: pointer;
        }
        .roman-numeral-details {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap; /* Allow wrapping if needed */
        }
        .roman-numeral-details label {
            font-weight: bold;
            margin-right: 5px;
            flex-shrink: 0;
        }
        .roman-numeral-details select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            flex-grow: 1;
            min-width: 150px; /* Ensure select is usable */
        }

        /* Roman Numeral Button Input Styling */
        .roman-numeral-item .roman-numeral-details {
            /* Ensure this container can accommodate button groups if not already flexible */
            display: flex; /* Already there, good */
            align-items: center; /* Already there, good */
            gap: 10px; /* Already there, good */
        }

        .roman-numeral-item .roman-numeral-details label {
            font-weight: bold;
            margin-right: 5px; /* Already there */
            flex-shrink: 0; /* Already there */
            /* Consider adjusting flex-basis or width if button groups make lines too long */
            /* For now, existing label style should be okay */
        }

        .roman-button-group {
            display: flex;
            flex-wrap: wrap; /* Allow buttons to wrap if many options */
            gap: 10px; /* Spacing between buttons */
            flex-grow: 1;
            justify-content: flex-start; /* Align buttons to the start */
        }

        .roman-numeral-btn {
            padding: 10px 15px;
            font-size: 1.1em;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
            min-width: 50px; /* Ensure a decent tap target */
            text-align: center;
        }

        .roman-numeral-btn:hover {
            background-color: #e0e0e0;
            border-color: #bbb;
        }

        .roman-numeral-btn.selected {
            background-color: #007bff;
            color: white;
            border-color: #0056b3;
            font-weight: bold;
        }

        /* Modifier selection styling */
        .modifier-display-painting img {
            width: 110px;
            height: 110px;
            object-fit: cover;
            border-radius: 4px;
            display: block;
            margin: 0 auto 5px auto;
        }
        .modifier-display-painting p {
            text-align: center;
            font-weight: bold;
            margin-bottom: 15px;
        }
        .modifier-groups {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .modifier-group {
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .modifier-btn {
            padding: 10px 15px;
            font-size: 1.1em;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            background-color: #f0f0f0;
            min-width: 50px;
            text-align: center;
        }
        .modifier-btn.selected {
            background-color: #007bff;
            color: white;
            border-color: #0056b3;
        }
        .modifier-btn.modifier-zero {
            background-color: #e0e0e0; /* Default for X */
        }
        .modifier-btn.modifier-zero.selected {
            background-color: #dc3545; /* Red when selected */
            color: white;
        }
        .modifier-btn.modifier-zero { /* Specific style for X button always */
            border-color: #dc3545;
            color: #dc3545;
        }


        /* Result step styling */
        .result-code {
            font-size: 2.5em;
            font-weight: bold;
            color: #28a745;
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background-color: #e9f5e9;
            border-radius: 5px;
        }
        .result-breakdown ul {
            list-style-type: none;
            padding: 0;
        }
        .result-breakdown li {
            background-color: #f9f9f9;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
            border: 1px solid #eee;
        }

        /* Modal styling */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            padding-top: 50px; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgb(0,0,0); 
            background-color: rgba(0,0,0,0.9);
        }
        .modal-content {
            margin: auto;
            display: block;
            width: 90%;
            max-width: 700px;
        }
        .modal-close-btn {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
        }
        .modal-close-btn:hover,
        .modal-close-btn:focus {
            color: #bbb;
            text-decoration: none;
            cursor: pointer;
        }
        
        .prominent-code {
            font-size: 1.5em;
            font-weight: bold;
            color: #dc3545; /* Red for prominence */
            text-align: center;
            margin: 10px 0;
        }

        /* Responsive adjustments */
        @media (max-width: 400px) {
            .picture-grid {
                grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); /* Smaller images for very small screens */
            }
            .picture-item img {
                width: 90px;
                height: 90px;
            }
             .roman-numeral-images img {
                width: 70px; 
                height: 70px;
            }
            #app-header {
                padding: 8px 10px;
            }
            #app-header button {
                padding: 6px 10px;
            }
            #step-title {
                font-size: 1em;
            }
            .modifier-btn {
                padding: 8px 10px;
                font-size: 1em;
                min-width: 40px;
            }
            /* Roman Numeral Buttons Responsive */
            .roman-numeral-btn {
                padding: 8px 10px;
                font-size: 1em;
                min-width: 40px;
            }
            .roman-button-group {
                gap: 8px;
            }
        }

        /* Configuration Page Sections */
        .config-section {
            margin-top: 20px;
            margin-bottom: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .config-section h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #333;
        }

        .config-option {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .config-option input[type="radio"] {
            margin-right: 8px;
            cursor: pointer;
        }

        .config-option label {
            cursor: pointer;
        }

        /* Config Page Styles */
        #config-btn {
            background-color: #0056b3;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1.1em; /* Adjusted to match other header buttons better */
            margin-left: 5px; /* Added for spacing */
            margin-right: 5px; /* Added for spacing */
        }
        #config-btn:disabled {
            background-color: #aaa;
            cursor: not-allowed;
        }

        #config-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #fff;
            z-index: 1100;
            overflow-y: auto;
            display: none; /* Initially hidden, JS will toggle */
        }

        #config-page-content {
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }
        
        #config-page-content h2 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }

        #painting-config-inputs {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        #painting-config-inputs div { /* Style for each dynamically generated input row */
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #painting-config-inputs label {
            flex-basis: 120px; /* Adjust as needed */
            font-weight: bold;
        }

        #painting-config-inputs input[type="text"] {
            flex-grow: 1;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 1em;
        }

        #save-config-btn, #reset-config-btn, #close-config-btn {
            display: block;
            width: 100%;
            margin-bottom: 10px;
            padding: 12px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-size: 1em;
            text-align: center;
        }

        #save-config-btn {
            background-color: #28a745; /* Green */
            color: white;
        }
        #save-config-btn:hover {
            background-color: #218838;
        }

        #reset-config-btn {
            background-color: #ffc107; /* Yellow */
            color: #333;
        }
        #reset-config-btn:hover {
            background-color: #e0a800;
        }

        #close-config-btn {
            background-color: #6c757d; /* Gray */
            color: white;
        }
        #close-config-btn:hover {
            background-color: #5a6268;
        }

    </style>
</head>
<body>
    <div id="app-container">
        <header id="app-header">
            <button id="prev-step-btn">< Back</button>
            <h2 id="step-title">Step Title</h2>
            <button id="config-btn">&#x1F6E0;</button>
            <button id="next-step-btn">Next ></button>
        </header>
        <main id="step-content">
            <!-- Content for the current step will be injected here -->
        </main>
        <footer id="app-footer">
            <button id="restart-btn">Restart</button>
        </footer>
    </div>

    <div id="config-page" style="display: none;">
        <div id="config-page-content">
            <h2>Configure Painting Names</h2>
            <div id="painting-config-inputs">
                <!-- Input fields will be dynamically added here by JavaScript later -->
                <!-- Example for one painting (for structure reference, JS will generate these):
                <div>
                    <label for="config-painting-horse">Horse:</label>
                    <input type="text" id="config-painting-horse" data-painting-id="Horse">
                </div>
                -->
            </div>

            <div class="config-section">
                <h4>Roman Numeral Input Style</h4>
                <div class="config-option">
                    <input type="radio" id="roman-input-dropdown" name="romanInputStyle" value="dropdown" checked>
                    <label for="roman-input-dropdown">Dropdown List</label>
                </div>
                <div class="config-option">
                    <input type="radio" id="roman-input-buttons" name="romanInputStyle" value="buttons">
                    <label for="roman-input-buttons">Buttons</label>
                </div>
            </div>

            <button id="save-config-btn">Save Configuration</button>
            <button id="reset-config-btn">Reset to Default</button>
            <button id="close-config-btn">Close</button>
        </div>
    </div>

    <div id="image-modal" class="modal">
        <span class="modal-close-btn" id="modal-close-btn">Ã—</span>
        <img class="modal-content" id="modal-img-src">
    </div>

    <script>
        const MAX_STEPS = 12;
        let currentStep = 1;
        let currentRomanInputStyle = 'dropdown'; // Default value

        // Data for selections
        let appData = {
            painting1_picture: null,
            painting2_picture: null,
            painting3_picture: null,
            painting4_picture: null,
            romanNumerals: {}, // { pictureName: integerValue }
            modifier1_value: null,
            modifier2_value: null,
            modifier3_value: null,
            modifier4_value: null,
        };

        let PICTURE_DATA = [ // Changed to let
            { id: "Horse", defaultName: "Horse", displayName: "Horse" },
            { id: "House", defaultName: "House", displayName: "House" },
            { id: "Snow", defaultName: "Snow", displayName: "Snow" },
            { id: "Tree", defaultName: "Tree", displayName: "Tree" },
            { id: "Boat", defaultName: "Boat", displayName: "Boat" },
            { id: "River", defaultName: "River", displayName: "River" },
            { id: "Owl", defaultName: "Owl", displayName: "Owl" },
            { id: "Lamb chop", defaultName: "Lamb chop", displayName: "Lamb chop" }
        ];

        const ROMAN_NUMERAL_OPTIONS = [
            { text: "Select Roman Numeral", value: null },
            { text: "I (1)", value: 1 }, { text: "II (2)", value: 2 }, { text: "III (3)", value: 3 },
            { text: "IV (4)", value: 4 }, { text: "V (5)", value: 5 }, { text: "VI (6)", value: 6 },
            { text: "VII (7)", value: 7 }, { text: "VIII (8)", value: 8 }, { text: "IX (9)", value: 9 },
            { text: "X (10)", value: 10 }
        ];

        const MODIFIERS = [-3, -2, -1, 0, 1, 2, 3];

        // DOM Elements
        let stepTitleElement, stepContentElement, prevStepBtn, nextStepBtn, restartBtn, imageModal, modalImg, modalCloseBtn;
        let configBtn, configPage, closeConfigBtn, appContainer; // Added new elements
        let paintingConfigInputsContainer, saveConfigBtn, resetConfigBtn; // Added reset button

        document.addEventListener('DOMContentLoaded', () => {
            loadCustomNames(); // Load custom names first

            stepTitleElement = document.getElementById('step-title');
            stepContentElement = document.getElementById('step-content');
            prevStepBtn = document.getElementById('prev-step-btn');
            nextStepBtn = document.getElementById('next-step-btn');
            restartBtn = document.getElementById('restart-btn');
            imageModal = document.getElementById('image-modal');
            modalImg = document.getElementById('modal-img-src');
            modalCloseBtn = document.getElementById('modal-close-btn');
            appContainer = document.getElementById('app-container'); // Ensure appContainer is selected

            configBtn = document.getElementById('config-btn');
            configPage = document.getElementById('config-page');
            closeConfigBtn = document.getElementById('close-config-btn');
            paintingConfigInputsContainer = document.getElementById('painting-config-inputs');
            saveConfigBtn = document.getElementById('save-config-btn'); 
            resetConfigBtn = document.getElementById('reset-config-btn'); // Select the reset button

            prevStepBtn.addEventListener('click', goPrevStep);
            nextStepBtn.addEventListener('click', goNextStep);
            restartBtn.addEventListener('click', restartApp);
            modalCloseBtn.addEventListener('click', closeModal);
            imageModal.addEventListener('click', (e) => { // Close if clicked outside image
                if (e.target === imageModal) {
                    closeModal();
                }
            });
            
            renderCurrentStep();

            if(configBtn) {
                configBtn.addEventListener('click', showConfigPage);
            }
            if(closeConfigBtn) {
                closeConfigBtn.addEventListener('click', hideConfigPage);
            }
            if(saveConfigBtn) { 
                saveConfigBtn.addEventListener('click', saveCustomNames);
            }
            if(resetConfigBtn) { // Add event listener for reset button
                resetConfigBtn.addEventListener('click', resetCustomNamesToDefault);
            }
        });

        // New functions for config page visibility
        function showConfigPage() {
            if(appContainer) appContainer.style.display = 'none';
            if(configPage) configPage.style.display = 'block';
            populateConfigInputs(); // Populate/refresh inputs each time config page is shown
        }

        function hideConfigPage() {
            if(configPage) configPage.style.display = 'none';
            if(appContainer) appContainer.style.display = 'flex'; // app-container uses flex
            renderCurrentStep(); // Re-render main view when config is closed to reflect changes
        }

        function saveCustomNames() {
            const customNamesToStore = {};
            let namesChanged = false; // Specifically for painting names

            // Select all relevant input fields from the config page
            const inputElements = document.querySelectorAll('#painting-config-inputs input[type="text"]');

            inputElements.forEach(inputElement => {
                const paintingId = inputElement.dataset.paintingId;
                const newDisplayName = inputElement.value.trim();
                
                const picture = PICTURE_DATA.find(p => p.id === paintingId);
                if (picture) {
                    let finalName = newDisplayName || picture.defaultName; // Use default if input is empty

                    if (picture.displayName !== finalName) {
                        picture.displayName = finalName;
                        namesChanged = true;
                    }
                    customNamesToStore[picture.id] = picture.displayName;
                }
            });

            if (namesChanged) {
                localStorage.setItem('customPaintingNames', JSON.stringify(customNamesToStore));
            }

            // Save Roman Numeral Input Style
            const selectedStyleElement = document.querySelector('input[name="romanInputStyle"]:checked');
            let styleChanged = false;
            if (selectedStyleElement) {
                if (currentRomanInputStyle !== selectedStyleElement.value) {
                    currentRomanInputStyle = selectedStyleElement.value;
                    styleChanged = true;
                }
                localStorage.setItem('romanNumeralInputStyle', currentRomanInputStyle);
            }

            if (namesChanged && styleChanged) {
                alert('Painting names and input style saved!');
            } else if (namesChanged) {
                alert('Painting names saved!');
            } else if (styleChanged) {
                alert('Roman numeral input style saved!');
            } else {
                alert('No changes detected.');
            }

            // Refresh the input fields to show trimmed values or reverted defaults
            populateConfigInputs(); 
            
            // Changes will be reflected when user navigates or closes config (due to renderCurrentStep in hideConfigPage)
        }

        function resetCustomNamesToDefault() {
            const confirmReset = confirm("Are you sure you want to reset all painting names and input style to their defaults? This cannot be undone.");
            if (confirmReset) {
                // Clear the custom names from localStorage
                localStorage.removeItem('customPaintingNames');
                // Reset displayName for each painting in PICTURE_DATA back to its defaultName
                PICTURE_DATA.forEach(pic => {
                    pic.displayName = pic.defaultName;
                });

                // Reset Roman Numeral Input Style
                currentRomanInputStyle = 'dropdown'; // Reset to default
                localStorage.setItem('romanNumeralInputStyle', currentRomanInputStyle);

                // Repopulate the input fields on the configuration page to show the defaults
                populateConfigInputs();

                alert('Configuration has been reset to default.');

                // Similar to saving, if the main app view needs immediate refresh:
                // The hideConfigPage function (if it calls renderCurrentStep) will handle this
                // when the user closes the config page.
            }
        }

        function loadCustomNames() { // Renamed in thought, but keeping as loadCustomNames for simplicity as per prompt
            // Load Painting Names
            const storedNames = localStorage.getItem('customPaintingNames');
            if (storedNames) {
                try {
                    const customNames = JSON.parse(storedNames);
                    PICTURE_DATA.forEach(pic => {
                        if (customNames[pic.id]) {
                            pic.displayName = customNames[pic.id];
                        } else {
                            pic.displayName = pic.defaultName;
                        }
                    });
                } catch (e) {
                    console.error("Error parsing custom painting names from localStorage:", e);
                    PICTURE_DATA.forEach(pic => pic.displayName = pic.defaultName);
                }
            } else {
                PICTURE_DATA.forEach(pic => pic.displayName = pic.defaultName);
            }

            // Load Roman Numeral Input Style
            const savedRomanInputStyle = localStorage.getItem('romanNumeralInputStyle');
            if (savedRomanInputStyle && (savedRomanInputStyle === 'dropdown' || savedRomanInputStyle === 'buttons')) {
                currentRomanInputStyle = savedRomanInputStyle;
            } else {
                currentRomanInputStyle = 'dropdown'; // Default if nothing valid is stored
                localStorage.setItem('romanNumeralInputStyle', currentRomanInputStyle); // Optional: store default
            }
        }

        function populateConfigInputs() {
            if (!paintingConfigInputsContainer) return;
            paintingConfigInputsContainer.innerHTML = ''; // Clear any existing inputs

            PICTURE_DATA.forEach(pic => {
                const inputDiv = document.createElement('div');
                // inputDiv.className = 'config-input-item'; // Using existing #painting-config-inputs div styles

                const label = document.createElement('label');
                label.htmlFor = `config-painting-${pic.id.replace(/ /g, '_')}`;
                label.textContent = `${pic.defaultName}:`; // Label with default name for clarity

                const input = document.createElement('input');
                input.type = 'text';
                input.id = `config-painting-${pic.id.replace(/ /g, '_')}`;
                input.dataset.paintingId = pic.id; // Store original ID for saving
                input.value = pic.displayName; // Set current display name

                inputDiv.appendChild(label);
                inputDiv.appendChild(input);
                paintingConfigInputsContainer.appendChild(inputDiv);
            });

            // Set radio buttons for Roman numeral input style
            if (currentRomanInputStyle === 'buttons') {
                document.getElementById('roman-input-buttons').checked = true;
            } else {
                document.getElementById('roman-input-dropdown').checked = true; // Default
            }
        }

        function getPictureImageSrc(pictureName, type) { // pictureName here is actually picture.id
            if (!pictureName) return ""; // Or a placeholder
            // Currently, pictureName is expected to be the 'id' (original name) from PICTURE_DATA
            // This will be updated later if necessary to distinguish between id and displayName for image paths
            return `images/${pictureName.toLowerCase().replace(/ /g, '_')}_${type}.PNG`;
        }
        
        function getRomanNumeralTextByValue(value) {
            const option = ROMAN_NUMERAL_OPTIONS.find(opt => opt.value === value);
            return option ? option.text.split(' ')[0] : 'N/A'; // e.g., "X" from "X (10)"
        }

        function resetAppData() {
            appData = {
                painting1_picture: null, painting2_picture: null, painting3_picture: null, painting4_picture: null,
                romanNumerals: {},
                modifier1_value: null, modifier2_value: null, modifier3_value: null, modifier4_value: null,
            };
        }

        function restartApp() {
            if (confirm("Are you sure you want to restart? All selections will be cleared.")) {
                resetAppData();
                currentStep = 1;
                renderCurrentStep();
            }
        }

        function goNextStep() {
            if (currentStep < MAX_STEPS) {
                currentStep++;
                renderCurrentStep();
            }
        }

        function goPrevStep() {
            if (currentStep > 1) {
                currentStep--;
                renderCurrentStep();
            }
        }
        
        function goToStep(stepNumber) {
            if (stepNumber >= 1 && stepNumber <= MAX_STEPS) {
                currentStep = stepNumber;
                renderCurrentStep();
            }
        }

        function updateNavigationButtonsState() {
            prevStepBtn.disabled = (currentStep === 1);
            
            // Default to enabled, then disable based on specific step conditions
            nextStepBtn.disabled = false;

            if (currentStep === MAX_STEPS) {
                nextStepBtn.disabled = true;
            } else if (currentStep >= 3 && currentStep <= 6) { // Painting selection steps
                const paintingKey = `painting${currentStep - 2}_picture`;
                nextStepBtn.disabled = !appData[paintingKey];
            } else if (currentStep === 7) { // Roman numerals step
                nextStepBtn.disabled = !areAllRomanNumeralsAssigned();
            } else if (currentStep >= 8 && currentStep <= 11) { // Modifier steps
                const modifierKey = `modifier${currentStep - 7}_value`;
                nextStepBtn.disabled = (appData[modifierKey] === null);
            }
        }
        
        function getUniqueSelectedPictures() {
            const selected = [
                appData.painting1_picture,
                appData.painting2_picture,
                appData.painting3_picture,
                appData.painting4_picture
            ].filter(p => p !== null); // Filter out nulls
            return [...new Set(selected)]; // Get unique names
        }

        function areAllRomanNumeralsAssigned() {
            const uniquePictures = getUniqueSelectedPictures();
            if (uniquePictures.length === 0) { // No pictures selected yet means not all assigned
                // Check if any painting is selected. If so, and unique is 0 (shouldn't happen), then false.
                // If no paintings selected at all, this step is not "complete" for auto-advance.
                const anyPaintingSelected = appData.painting1_picture || appData.painting2_picture || appData.painting3_picture || appData.painting4_picture;
                return !anyPaintingSelected; // True if no paintings selected, false otherwise
            }
            return uniquePictures.every(picName => appData.romanNumerals[picName] !== undefined && appData.romanNumerals[picName] !== null);
        }

        function renderCurrentStep() {
            stepContentElement.innerHTML = ''; // Clear previous content
            let title = "";

            switch (currentStep) {
                case 1: title = "Workflow"; renderStep1(); break;
                case 2: title = "Lockdown"; renderStep2(); break;
                case 3: title = "Select painting 1"; renderPaintingSelectionStep(1); break;
                case 4: title = "Select painting 2"; renderPaintingSelectionStep(2); break;
                case 5: title = "Select painting 3"; renderPaintingSelectionStep(3); break;
                case 6: title = "Select painting 4"; renderPaintingSelectionStep(4); break;
                case 7: title = "Roman numerals"; renderRomanNumeralsStep(); break;
                case 8: title = "Select modifier 1"; renderModifierSelectionStep(1); break;
                case 9: title = "Select modifier 2"; renderModifierSelectionStep(2); break;
                case 10: title = "Select modifier 3"; renderModifierSelectionStep(3); break;
                case 11: title = "Select modifier 4"; renderModifierSelectionStep(4); break;
                case 12: title = "Result"; renderResultStep(); break;
            }
            stepTitleElement.textContent = title;
            updateNavigationButtonsState();
            window.scrollTo(0, 0); // Scroll to top on step change
        }

        // --- Step 1: Workflow ---
        function renderStep1() {
            stepContentElement.innerHTML = `
                <h3>Workflow Explanation</h3>
                <ol>
                    <li><strong>Understand the Workflow:</strong> (This is the current step you are reading).</li>
                    <li><strong>Secure and Access:</strong> Lockdown the building, then unlock the computer using the keypad.</li>
                    <li><strong>Select Paintings:</strong> Access the computer and select the paintings displayed on the screen.</li>
                    <li><strong>Find Roman Numerals:</strong> Locate the four physical paintings you selected and note the Roman numeral beneath each one.</li>
                    <li><strong>Select Modifiers:</strong> Return to the computer and select the modifiers that are displayed after each of the four paintings.</li>
                    <li><strong>Escape:</strong> Input the final code (which will be displayed on the computer). Then, quickly head to the metro station.</li>
                </ol>
                <p><strong>Note:</strong> You can customize painting names in the configuration settings to match terms you're familiar with.</p>
                <button class="action-button" id="step1-next">Yeah yeah, I know, NEXT!!</button>
            `;
            document.getElementById('step1-next').addEventListener('click', () => goNextStep());
        }

        // --- Step 2: Lockdown ---
        function renderStep2() {
            stepContentElement.innerHTML = `
                <p>Lockdown Code: <strong class="prominent-code">2179</strong></p>
                <button class="action-button" id="step2-next">Sure, NEXT PLEASE!</button>
            `;
            document.getElementById('step2-next').addEventListener('click', () => goNextStep());
        }

        // --- Steps 3-6: Painting Selection ---
        function renderPaintingSelectionStep(paintingNum) {
            const appDataKey = `painting${paintingNum}_picture`;
            let gridHtml = '<div class="picture-grid">';
            PICTURE_DATA.forEach(pic => {
                const isSelected = appData[appDataKey] === pic.id; // Use pic.id for data storage
                gridHtml += `
                    <div class="picture-item ${isSelected ? 'selected' : ''}" data-picture-id="${pic.id}">
                        <img src="${getPictureImageSrc(pic.id, 'screen')}" alt="${pic.displayName} screen version">
                        <span>${pic.displayName}</span>
                    </div>
                `;
            });
            gridHtml += '</div>';
            stepContentElement.innerHTML = gridHtml;

            document.querySelectorAll('.picture-item').forEach(item => {
                item.addEventListener('click', () => {
                    appData[appDataKey] = item.dataset.pictureId; // Store pic.id
                    // Re-render to update selection visuals and then auto-advance
                    renderCurrentStep(); // This updates selection class
                    if (currentStep < 7) { // Auto-advance from painting steps to next or Roman Numerals
                       setTimeout(goNextStep, 100); // Short delay for visual feedback
                    }
                });
            });
        }

        // --- Step 7: Roman numerals ---
        function renderRomanNumeralsStep() {
            const uniquePictures = getUniqueSelectedPictures();
            if (uniquePictures.length === 0) {
                stepContentElement.innerHTML = "<p>No pictures selected yet. Please select pictures in Painting 1-4 steps.</p>";
                updateNavigationButtonsState(); // Ensure nav is updated even if no pictures
                return;
            }

            let html = '';
            uniquePictures.forEach(picId => { // Changed variable name for clarity
                const picData = PICTURE_DATA.find(p => p.id === picId);
                if (!picData) return; // Should not happen if uniquePictures is derived correctly

                const displayName = picData.displayName;
                const screenSrc = getPictureImageSrc(picId, 'screen');
                const paintingSrc = getPictureImageSrc(picId, 'painting');
                const currentRomanValue = appData.romanNumerals[picId] || null;

                html += `
                    <div class="roman-numeral-item" data-picture-id="${picId}">
                        <div class="roman-numeral-images">
                            <img src="${screenSrc}" alt="${displayName} screen">
                            <img src="${paintingSrc}" alt="${displayName} painting" class="painting-image-preview" data-painting-src="${paintingSrc}">
                        </div>
                        <div class="roman-numeral-details">
                            <label for="roman-input-${picId.replace(/ /g, '_')}">${displayName}:</label>`; // Changed label 'for' to be more generic initially

                if (currentRomanInputStyle === 'buttons') {
                    html += `<div class="roman-button-group" id="roman-input-${picId.replace(/ /g, '_')}">`;
                    ROMAN_NUMERAL_OPTIONS.forEach(opt => {
                        if (opt.value === null) return; // Skip "Select Roman Numeral"
                        const isSelected = opt.value === currentRomanValue;
                        const romanNumeralChar = opt.text.split(' ')[0]; // e.g., "V"
                        const numericValue = opt.value; // e.g., 5
                        html += `<button class="roman-numeral-btn ${isSelected ? 'selected' : ''}" 
                                         data-picture-id="${picId}" 
                                         data-value="${numericValue}">
                                         <span style="font-weight:bold;">${romanNumeralChar}</span> <span style="color: #555555;">(${numericValue})</span>
                                 </button>`;
                    });
                    html += `</div>`;
                } else { // Default to dropdown
                    html += `<select class="roman-numeral-select" id="roman-input-${picId.replace(/ /g, '_')}" data-picture-id="${picId}">`; // Added class for easier selection
                    ROMAN_NUMERAL_OPTIONS.forEach(opt => {
                        html += `<option value="${opt.value === null ? '' : opt.value}" ${opt.value === currentRomanValue ? 'selected' : ''}>${opt.text}</option>`;
                    });
                    html += `</select>`;
                }
                html += `   </div> <!-- closes roman-numeral-details -->
                        </div> <!-- closes roman-numeral-item -->`;
            });

            stepContentElement.innerHTML = html;

            // Attach common event listeners
            document.querySelectorAll('.painting-image-preview').forEach(img => {
                img.addEventListener('click', (event) => {
                    openModal(event.target.dataset.paintingSrc);
                });
            });

            // Attach specific event listeners based on input style
            if (currentRomanInputStyle === 'buttons') {
                document.querySelectorAll('.roman-numeral-btn').forEach(button => {
                    button.addEventListener('click', handleRomanNumeralButtonClick); // This function will be created in next step
                });
            } else {
                document.querySelectorAll('.roman-numeral-select').forEach(select => { // Target by new class
                    select.addEventListener('change', (event) => {
                        const selectedPicId = event.target.dataset.pictureId; // Changed to pictureId
                        const value = event.target.value === "" ? null : parseInt(event.target.value);
                        appData.romanNumerals[selectedPicId] = value;
                        updateNavigationButtonsState();
                        if (areAllRomanNumeralsAssigned()) {
                            setTimeout(goNextStep, 100);
                        }
                    });
                });
            }
            updateNavigationButtonsState(); // Call once after setup
        }

        function handleRomanNumeralButtonClick(event) {
            const clickedButton = event.currentTarget; 
            const picId = clickedButton.dataset.pictureId;
            const value = parseInt(clickedButton.dataset.value);

            if (!picId || isNaN(value)) {
                console.error("Button click error: Missing pictureId or value", clickedButton.dataset);
                return;
            }

            // Update appData
            appData.romanNumerals[picId] = value;

            // Update button visual selection within the same group
            const buttonGroupId = `roman-input-${picId.replace(/ /g, '_')}`;
            const buttonGroup = document.getElementById(buttonGroupId);

            if (buttonGroup) {
                const buttonsInGroup = buttonGroup.querySelectorAll('.roman-numeral-btn');
                buttonsInGroup.forEach(btn => {
                    if (btn === clickedButton) {
                        btn.classList.add('selected');
                    } else {
                        btn.classList.remove('selected');
                    }
                });
            } else {
                // Fallback/alternative if direct parent traversal is preferred and structure is known
                // This assumes the button group is the direct parent. Adjust if structure is different.
                // console.warn("Button group not found by ID, trying parent traversal for:", picId);
                // const parentGroup = clickedButton.parentElement;
                // if (parentGroup && parentGroup.classList.contains('roman-button-group')) {
                //     parentGroup.querySelectorAll('.roman-numeral-btn').forEach(btn => {
                //         btn.classList.remove('selected');
                //     });
                //     clickedButton.classList.add('selected');
                // }
            }
            
            // Update navigation and potentially auto-advance
            updateNavigationButtonsState();
            if (areAllRomanNumeralsAssigned()) {
                setTimeout(goNextStep, 100);
            }
        }
        
        function openModal(imageSrc) {
            modalImg.src = imageSrc;
            imageModal.style.display = "block";
        }

        function closeModal() {
            imageModal.style.display = "none";
            modalImg.src = ""; // Clear src
        }

        // --- Steps 8-11: Modifier Selection ---
        function renderModifierSelectionStep(modifierNum) {
            const paintingKey = `painting${modifierNum}_picture`;
            const modifierKey = `modifier${modifierNum}_value`;
            const selectedPictureId = appData[paintingKey]; // This is an ID

            if (!selectedPictureId) {
                stepContentElement.innerHTML = `<p>No painting selected for Painting ${modifierNum}. Please go back and select one.</p>`;
                return;
            }
            const picData = PICTURE_DATA.find(p => p.id === selectedPictureId);
            if (!picData) {
                stepContentElement.innerHTML = `<p>Error: Painting data not found for ID ${selectedPictureId}.</p>`;
                return;
            }

            const screenSrc = getPictureImageSrc(picData.id, 'screen');
            const currentModifier = appData[modifierKey];

            let modifierButtonsHtml = '<div class="modifier-groups">';
            // Group 1: -3, -2, -1
            modifierButtonsHtml += '<div class="modifier-group">';
            [-3, -2, -1].forEach(mod => {
                modifierButtonsHtml += `<button class="modifier-btn ${currentModifier === mod ? 'selected' : ''}" data-value="${mod}">${mod}</button>`;
            });
            modifierButtonsHtml += '</div>';
            
            // Group 2: X (0)
            modifierButtonsHtml += '<div class="modifier-group">';
            const zeroSelected = currentModifier === 0;
            modifierButtonsHtml += `<button class="modifier-btn modifier-zero ${zeroSelected ? 'selected' : ''}" data-value="0">X</button>`;
            modifierButtonsHtml += '</div>';

            // Group 3: +1, +2, +3
            modifierButtonsHtml += '<div class="modifier-group">';
            [1, 2, 3].forEach(mod => {
                modifierButtonsHtml += `<button class="modifier-btn ${currentModifier === mod ? 'selected' : ''}" data-value="${mod}">+${mod}</button>`;
            });
            modifierButtonsHtml += '</div>';
            modifierButtonsHtml += '</div>';


            stepContentElement.innerHTML = `
                <div class="modifier-display-painting">
                    <img src="${screenSrc}" alt="${picData.displayName} screen">
                    <p>${picData.displayName}</p>
                </div>
                ${modifierButtonsHtml}
            `;

            document.querySelectorAll('.modifier-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    appData[modifierKey] = parseInt(btn.dataset.value);
                    renderCurrentStep(); // Re-render to update selection visuals
                    if (currentStep < 12) { // Auto-advance from modifier steps
                        setTimeout(goNextStep, 100);
                    }
                });
            });
        }

        // --- Step 12: Result ---
        function renderResultStep() {
            let missingInfo = [];
            if (!appData.painting1_picture) missingInfo.push("Painting 1 selection");
            if (!appData.painting2_picture) missingInfo.push("Painting 2 selection");
            if (!appData.painting3_picture) missingInfo.push("Painting 3 selection");
            if (!appData.painting4_picture) missingInfo.push("Painting 4 selection");

            const uniquePictures = getUniqueSelectedPictures(); // This returns array of IDs
            uniquePictures.forEach(picId => {
                const picData = PICTURE_DATA.find(p => p.id === picId);
                const displayName = picData ? picData.displayName : picId; // Fallback to ID if not found (should not happen)
                if (appData.romanNumerals[picId] === undefined || appData.romanNumerals[picId] === null) {
                    missingInfo.push(`Roman numeral for ${displayName}`);
                }
            });
            
            if (appData.modifier1_value === null) missingInfo.push("Modifier for Painting 1");
            if (appData.modifier2_value === null) missingInfo.push("Modifier for Painting 2");
            if (appData.modifier3_value === null) missingInfo.push("Modifier for Painting 3");
            if (appData.modifier4_value === null) missingInfo.push("Modifier for Painting 4");

            // Check if any unique picture is actually selected before checking their roman numerals
            const paintingsSelectedCount = [appData.painting1_picture, appData.painting2_picture, appData.painting3_picture, appData.painting4_picture].filter(Boolean).length;
            if (paintingsSelectedCount > 0 && uniquePictures.length === 0) {
                 // This case should ideally not happen if logic is correct, but as a fallback
                missingInfo.push("Processing selected paintings for Roman numerals (internal error or incomplete prior step)");
            }


            if (missingInfo.length > 0) {
                stepContentElement.innerHTML = `
                    <h3>Incomplete Information</h3>
                    <p>Please complete all previous steps. Missing:</p>
                    <ul>${missingInfo.map(item => `<li>${item}</li>`).join('')}</ul>
                `;
                return;
            }

            let finalCode = "";
            let breakdownHtml = "<h3>Calculation Breakdown:</h3><ul>";

            for (let i = 1; i <= 4; i++) {
                const pictureId = appData[`painting${i}_picture`]; // This is an ID
                const picData = PICTURE_DATA.find(p => p.id === pictureId);
                const displayName = picData ? picData.displayName : pictureId; // Fallback to ID

                const modifierValue = appData[`modifier${i}_value`];
                const romanNumeralValue = appData.romanNumerals[pictureId];

                if (pictureId === null || modifierValue === null || romanNumeralValue === null || romanNumeralValue === undefined) {
                    // This check is a safeguard; primary check is `missingInfo` above.
                    stepContentElement.innerHTML = `<p>Error: Data inconsistency for item ${i} (${displayName}). Please review previous steps.</p>`;
                    return;
                }
                
                const resultDigit = romanNumeralValue + modifierValue;
                finalCode += resultDigit.toString();

                const romanNumeralText = getRomanNumeralTextByValue(romanNumeralValue);
                const modifierText = modifierValue === 0 ? "X" : (modifierValue > 0 ? `+${modifierValue}` : modifierValue.toString());

                breakdownHtml += `
                    <li>
                        Digit ${i} (${displayName}: ${romanNumeralText}, ${modifierText}): ${romanNumeralValue} ${modifierValue < 0 ? '-' : '+'} ${Math.abs(modifierValue)} = <strong>${resultDigit}</strong>
                    </li>`;
            }
            breakdownHtml += "</ul>";

            stepContentElement.innerHTML = `
                <h3>Final Code</h3>
                <div class="result-code">${finalCode}</div>
                <div class="result-breakdown">${breakdownHtml}</div>
            `;
        }

    </script>
</body>
</html>